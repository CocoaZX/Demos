//
//  McBaseWebViewController.m
//  Mocha
//
//  Created by zhoushuai on 16/5/28.
//  Copyright © 2016年 renningning. All rights reserved.
//

#import "McBaseWebViewController.h"
#import "JSONKit.h"
#import "DaShangViewController.h"
#import "JinBiViewController.h"
@interface McBaseWebViewController ()<UIAlertViewDelegate,UIActionSheetDelegate>

@end


@implementation McBaseWebViewController
#pragma mark - 视图生命周期及控件加载
- (void)viewDidLoad {
    [super viewDidLoad];
    [self.view addSubview:self.webView];
    
    //加载进度
    _progressProxy = [[NJKWebViewProgress alloc] init];
    _webView.delegate = _progressProxy;
    _progressProxy.webViewProxyDelegate = self;
    _progressProxy.progressDelegate = self;
    
    CGFloat progressBarHeight = 3.f;
    CGRect navigationBarBounds = self.navigationController.navigationBar.bounds;
    CGRect barFrame = CGRectMake(0, navigationBarBounds.size.height, navigationBarBounds.size.width, progressBarHeight);
    _progressView = [[NJKWebViewProgressView alloc] initWithFrame:barFrame];
    _progressView.autoresizingMask = UIViewAutoresizingFlexibleWidth | UIViewAutoresizingFlexibleTopMargin;
    [self.progressView setProgress:0 animated:YES];
    
    
    
    //h5界面支付成功或者失败的通知监听
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(weiXinPaySuccess) name:@"WxPaySuccess" object:nil];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(weiXinPayFail) name:@"payFailed" object:nil];
 }

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
}

- (void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
    [self.navigationController.navigationBar addSubview:_progressView];

}

-(void)viewDidDisappear:(BOOL)animated{
    [super viewDidDisappear:animated];
    self.isPerformLogIn = false;
    [_progressView removeFromSuperview];
    
}

- (void)dealloc{
    [_progressView removeFromSuperview];
    //移除通知
    [[NSNotificationCenter defaultCenter] removeObserver:self name:@"WxPaySuccess" object:nil];
    [[NSNotificationCenter defaultCenter] removeObserver:self name:@"payFailed" object:nil];
}


#pragma mark - 导航栏分享
//用于分享当前的网页
- (void)setNavigationBarShareButtionItem{
    BOOL isAppearThirdLogin = [USER_DEFAULT boolForKey:ConfigThird];
    if (isAppearThirdLogin) {
        //导航栏上显示分享按钮
        UIButton *rightBtn = [[UIButton alloc] initWithFrame:CGRectMake(0, 0,50,30)];
        [rightBtn setTitle:@"分享" forState:UIControlStateNormal];
        [rightBtn setTitleColor:[CommonUtils colorFromHexString:kLikeRedColor] forState:UIControlStateNormal];
        [rightBtn addTarget:self action:@selector(showShareActionView) forControlEvents:UIControlEventTouchUpInside];
        UIBarButtonItem *rightItem = [[UIBarButtonItem alloc] initWithCustomView:rightBtn];
        self.navigationItem.rightBarButtonItem = rightItem;
    }
}


-(void)showShareActionView{
    NSLog(@"shareInformationMethod");
    UIActionSheet *actionSheet = [[UIActionSheet alloc] initWithTitle:nil
                                                             delegate:self
                                                    cancelButtonTitle:@"取消"
                                               destructiveButtonTitle:nil
                                                    otherButtonTitles:@"推荐到微信朋友圈",@"推荐到微信好友",@"推荐给QQ好友",nil];
    [actionSheet showInView:self.view];
}


-(void)actionSheet:(UIActionSheet *)actionSheet clickedButtonAtIndex:(NSInteger)buttonIndex{
    
    //分享的标题
    NSString *shareTitle = [self.webView stringByEvaluatingJavaScriptFromString:@"document.title"];
    
    //分享的链接
    NSString *shareURL = self.webView.request.URL.absoluteString;
    
    //分享的描述
    NSString *shareDesc = @"";
    NSString *jsforDesc = @"";
    jsforDesc  = @"document.getElementsByName('mokaDescription')[0].getAttribute('content')";
    shareDesc = [self.webView stringByEvaluatingJavaScriptFromString:jsforDesc];
    shareDesc = getSafeString(shareDesc);
    if (shareDesc.length == 0) {
        jsforDesc = @"document.getElementsByName('Description')[0].getAttribute('content')";
        shareDesc = [self.webView stringByEvaluatingJavaScriptFromString:jsforDesc];
        shareDesc = getSafeString(shareDesc);
        if (shareDesc.length == 0) {
            jsforDesc = @"document.getElementsByName('title')[0].getAttribute('content')";
            shareDesc = [self.webView stringByEvaluatingJavaScriptFromString:jsforDesc];
            shareDesc = getSafeString(shareDesc);
        }
    }
    
    //获取图片
    UIImage *coverImg = nil;
    NSString *jsForImage =@"document.getElementsByName('mokaLogo')[0].getAttribute('content')";
    NSString *imageStr = [self.webView stringByEvaluatingJavaScriptFromString:jsForImage];
    if(imageStr.length != 0){
        coverImg= [UIImage imageWithData:[NSData dataWithContentsOfURL:[NSURL URLWithString:imageStr]]];
    }else{
        coverImg = [UIImage imageNamed:@"AppIcon40x40"];
    }
    
    switch (buttonIndex) {
        case 0:
        {
            //朋友圈
            [(AppDelegate *)[UIApplication sharedApplication].delegate changeScene:WXSceneTimeline];
            [(AppDelegate *)[UIApplication sharedApplication].delegate sendWeiXInLinkContentTitle:shareTitle desc:shareDesc header:coverImg URL:shareURL uid:getCurrentUid() withuseType:@"webPageShare"];
        }
            break;
        case 1:
        {
            //微信
            [(AppDelegate *)[UIApplication sharedApplication].delegate changeScene:WXSceneSession];
            [(AppDelegate *)[UIApplication sharedApplication].delegate sendWeiXInLinkContentTitle:shareTitle desc:shareDesc header:coverImg URL:shareURL uid:getCurrentUid() withuseType:@"webPageShare"];
        }
            break;
            
        case 2:
        {
            //QQ
            NSData *imageData = UIImageJPEGRepresentation(coverImg, 1);
            
            [(AppDelegate *)[UIApplication sharedApplication].delegate sendMessageToQQIsQzone:NO decription:shareDesc title:shareTitle imageData:imageData targetUrl:shareURL objectId:@"" withuseType:@"webPageShare"];
        }
            break;
        default:
            break;
    }
}


#pragma mark - JS交互
- (void)communicateWithJS:(JSContext *)context withVC:(McBaseWebViewController *)viewController{
    
    //网页加载完成调用此方法
    //js调用iOS
    //首先创建JSContext 对象（此处通过当前webView的键获取到jscontext）
    __weak typeof (McBaseWebViewController *) vc = viewController;
     //1.获取用户ID
    context[@"uidRequest"] = ^() {
        vc.webUserID= getCurrentUid();
        if (vc.webUserID.length == 0) {
            vc.webUserID = @"-1";
        }
        JSContext *context_=[vc.webView valueForKeyPath:@"documentView.webView.mainFrame.javaScriptContext"];
        [context_ evaluateScript:[NSString stringWithFormat:@"getuid(%@)",vc.webUserID]];
     };

    //2.执行登陆
    context[@"gotoLoginRequest"] = ^() {
        [vc performLogIn:vc];
     };
    
    //3.支付
    context[@"paymentRequest"] = ^() {
        NSArray *args = [JSContext currentArguments];
        for (id obj in args) {
            NSLog(@"%@",obj);
            NSString *string = getSafeString(obj);
            NSDictionary *jsonDiction = [string objectFromJSONString];
            //模板参数
            vc.webPayTitle = getSafeString(jsonDiction[@"title"]);
            vc.webPayDesc =getSafeString(jsonDiction[@"description"]) ;
            vc.webPayType = getSafeString(jsonDiction[@"type"]);
            vc.webPayAmount = getSafeString(jsonDiction[@"amount"]) ;
            vc.webPayTargetType = getSafeString(jsonDiction[@"webPayTargetType"]) ;
            vc.webPayTargetID = getSafeString(jsonDiction[ @"webPayTargetID"]) ;
            //回调部分
            vc.webPayCallBackFunc = getSafeString(jsonDiction[@"callback"]);
            vc.webPaycallBackData = getSafeString(jsonDiction[@"callbackdata"]);
        }
        if ([vc.webPayType isEqualToString:@"0"]) {
            //金币支付
            [vc showpayGoldCoinWindow:nil];
        }else{
            //现金支付
            [vc showPayVC];
        }
    };
}




#pragma mark - JS执行:登陆
- (void)performLogIn:(McBaseWebViewController *)vc{
    if (getCurrentUid().length == 0) {
        [(AppDelegate *)[UIApplication sharedApplication].delegate showAccountViewControllerWithCon:vc];
    }else{
        [LeafNotification showInController:vc withText:@"当前已经登陆"];
    }
}





#pragma mark - JS执行：通用金币打赏
//展示金币打赏界面
- (void)showpayGoldCoinWindow:(NSDictionary *)diction{
    //中间视图的宽高度payGoldCoinWindow
    CGFloat lefttingPadding = 30;
    CGFloat horizontalPadding = 20;
    CGFloat mainViewWidth = kDeviceWidth -30*2;
    if (_payGoldCoinWindow == nil) {
        //创建window
        _payGoldCoinWindow = [[UIWindow alloc] initWithFrame:[UIScreen mainScreen].bounds];
        _payGoldCoinWindow.backgroundColor = [UIColor clearColor];
        _payGoldCoinWindow.hidden = NO;
        _payGoldCoinWindow.windowLevel = UIWindowLevelStatusBar;
        
        //设置黑色背景
        UIView *backView = [[UIView alloc]initWithFrame:CGRectMake(0, 0, kDeviceWidth, kDeviceHeight)];
        backView.backgroundColor = [CommonUtils colorFromHexString:@"#F8F6F3"];
        backView.backgroundColor = [UIColor blackColor];
        backView.alpha = 0.5;
        [_payGoldCoinWindow addSubview:backView];
        
        //主视图
        UIView *mainView = [[UIView alloc] initWithFrame:CGRectZero];
        mainView.tag = 1000;
        mainView.backgroundColor = [UIColor whiteColor];
        [_payGoldCoinWindow addSubview:mainView];
        
        //取消按钮
        UIButton *cancleBtn = [[UIButton alloc] initWithFrame:CGRectMake(mainViewWidth - 10- 30, 5, 30, 30)];
        [cancleBtn setImage:[UIImage imageNamed: @"close2"] forState:UIControlStateNormal];
        [cancleBtn addTarget:self action:@selector(closeServiceAlertView) forControlEvents:UIControlEventTouchUpInside];
        [mainView addSubview:cancleBtn];
        
        
        NSString *alterTitle = @"使用金币支付";
        NSString *descTxt = @"支付金币用于开启了打赏之后接受私信 ,你需要先打赏对方才能发送消息";
         if (self.webPayTitle.length != 0) {
            alterTitle = self.webPayTitle;
        }
         if (self.webPayDesc.length != 0) {
            descTxt = self.webPayDesc;
        }
        
        //标题
        UILabel *titleLabel = [[UILabel alloc] initWithFrame:CGRectMake(horizontalPadding, cancleBtn.bottom +5, mainViewWidth -horizontalPadding*2,horizontalPadding)];
        titleLabel.textAlignment = NSTextAlignmentCenter;
        titleLabel.font = [UIFont boldSystemFontOfSize:18];
        titleLabel.text = alterTitle;
        [mainView addSubview:titleLabel];
        
        //内容
        CGFloat descHeight= [SQCStringUtils getCustomHeightWithText:descTxt viewWidth:mainViewWidth -horizontalPadding *2 textSize:16];
        UILabel *descLabel = [[UILabel alloc] initWithFrame:CGRectMake(horizontalPadding, titleLabel.bottom + 20, mainViewWidth -horizontalPadding *2, descHeight +10)];
        descLabel.numberOfLines = 0;
        descLabel.font = [UIFont systemFontOfSize:16];
        descLabel.text =descTxt;
        [mainView addSubview:descLabel];
        
        //打赏按钮
        UIControl *daShangCtrl = [[UIControl alloc] initWithFrame:CGRectMake((mainViewWidth -160)/2, descLabel.bottom +20, 160, 40)];
        daShangCtrl.backgroundColor = [CommonUtils colorFromHexString:@"#eeeae4"];
        [mainView addSubview:daShangCtrl];
        
        UILabel *colorLabel = [[UILabel alloc] initWithFrame:CGRectMake(0, 0, 40, 40)];
        colorLabel.backgroundColor = [CommonUtils colorFromHexString:@"#D2CBA1"];
        colorLabel.layer.cornerRadius = 20;
        colorLabel.layer.masksToBounds = YES;
        [daShangCtrl addSubview:colorLabel];
        
        UILabel *daShangCountLable = [[UILabel alloc] initWithFrame:CGRectMake(colorLabel.right, 0, 120, 40)];
        daShangCountLable.textAlignment = NSTextAlignmentCenter;
        daShangCountLable.text = [NSString stringWithFormat:@"打赏%@个",self.webPayAmount];
        [daShangCtrl addSubview:daShangCountLable];
        daShangCtrl.layer.cornerRadius = 20;
        daShangCtrl.layer.masksToBounds =YES;
        [daShangCtrl addTarget:self action:@selector(requestDaShangWithGoldCoin) forControlEvents:UIControlEventTouchUpInside];
        
        CGFloat mainViewHeight = daShangCtrl.bottom +20;
        mainView.frame = CGRectMake(lefttingPadding, (kDeviceHeight -mainViewHeight)/2,mainViewWidth,mainViewHeight);
        mainView.layer.cornerRadius = 5;
        mainView.layer.masksToBounds = YES;
        
    }
    //执行动画
    UIView *mainView = [_payGoldCoinWindow viewWithTag:1000];
    CABasicAnimation *forwardAnimation = [CABasicAnimation animationWithKeyPath:@"transform.scale"];
    forwardAnimation.duration =0.5;
    forwardAnimation.timingFunction = [CAMediaTimingFunction functionWithControlPoints:0.5f :1.7f :0.6f :0.85f];
    forwardAnimation.fromValue = [NSNumber numberWithFloat:0.0f];
    forwardAnimation.toValue = [NSNumber numberWithFloat:1.0f];
    [mainView.layer addAnimation:forwardAnimation forKey:@"test"];
}

//手势关闭"打开通知"的引导视图
- (void)closeServiceAlertView{
    UIView *mainView = [_payGoldCoinWindow viewWithTag:1000];
    CABasicAnimation *reverseAnimation = [CABasicAnimation animationWithKeyPath:@"transform.scale"];
    reverseAnimation.duration = 0.5;
    reverseAnimation.timingFunction = [CAMediaTimingFunction functionWithControlPoints:0.4f :0.15f :0.5f :-0.7f];
    reverseAnimation.fromValue = [NSNumber numberWithFloat:1.0f];
    reverseAnimation.toValue = [NSNumber numberWithFloat:0.0f];
    //使rocket留在最终状态，设置removedOnCompletion为No以防止它被自动移除
    reverseAnimation.fillMode =  kCAFillModeForwards;
    reverseAnimation.removedOnCompletion = NO;
    [mainView.layer addAnimation:reverseAnimation forKey:@"test"];
    
    //隐藏window并且清除
    [UIView animateWithDuration:0.6 animations:^{
        _payGoldCoinWindow.alpha = 0;
        
    } completion:^(BOOL finished) {
        _payGoldCoinWindow.hidden = NO;
        _payGoldCoinWindow =nil;
    }];
    
}


//进入打赏金币的界面
- (void)requestDaShangWithGoldCoin{
    
    if ([self isFailForCheckLogInStatus]) {
        return;
    }
    
    NSMutableDictionary *mDic = [NSMutableDictionary dictionary];
    //类型
    [mDic setObject:self.webPayTargetType forKey:@"object_type"];
    //对象编号
    [mDic setObject:self.webPayTargetID forKey:@"object_id"];
    //描述
    [mDic setObject:self.webPayDesc forKey:@"description"];
    //支付的金额
    NSString *goldCoin = self.webPayAmount;
    //NSString *goldCoin = @"8";
    NSDictionary *payArr = @{@"1":@"0",@"2":@"0",@"3":goldCoin};
    NSString *pay_info = [SQCStringUtils JSONStringWithDic:payArr];
   [mDic setObject:pay_info forKey:@"pay_info"];
    
    NSDictionary *params = [AFParamFormat formatTempleteParams:mDic];
    
    [AFParamFormat formatTempleteParams:mDic];
    
    [AFNetwork postRequeatDataParams:params path:PathCustomPay success:^(id data) {
        [self closeServiceAlertView];

        NSLog(@"data:%@",data);
        NSInteger statusNum = [data[@"status"] integerValue];
        //statusNum = 6230;
        switch (statusNum) {
            case 0:
            {
                //支付金币成功
                [LeafNotification showInController:self withText:data[@"msg"]];
                [self performWeiXinpay:@"1"];
                break;
            }
            case 6230:
            {   //金币不够提示是否购买
                UIAlertView *alertView = [[UIAlertView alloc] initWithTitle:@"金币打赏" message:@"您的账户金币不足,快去充值吧~" delegate:self cancelButtonTitle:@"取消" otherButtonTitles:@"充值", nil];
                [alertView show];
                break;
            }
            case 1:
            {
                //支付失败
                [LeafNotification showInController:self withText:data[@"msg"]];
                [self performWeiXinpay:@"0"];
                 break;
            }
            default:{
                [LeafNotification showInController:self withText:data[@"msg"]];
                break;
            }
        }
    } failed:^(NSError *error) {
        NSLog(@"%@",error);
        [LeafNotification showInController:self withText:@"网页不太顺畅哦"];
    }];
}


- (void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex{
    if (buttonIndex == 0) {
        //取消购买
    }else{
        //清除此时的h5回调参数，因为使用微信支付会发出支付成功或者失败的通知
        //而本界面监听到到此微信支付的消息时会执行h5的回调
        //购买金币不是本界面支付需求，所以不应该执行回调
        //这里通过清除h5回调参数的方法，来阻止因为购买金币而引起的支付回调
        [self clearPayParameters];
        //跳转到充值界面
        [self skipPageForBuyGoldCoin ];
    }
}

//金币不够，购买金币
- (void)skipPageForBuyGoldCoin{
    JinBiViewController *jinBiVC = [[JinBiViewController alloc] init];
    [self.navigationController pushViewController:jinBiVC animated:YES];
}



#pragma mark - JS执行：通用钱包或者微信支付
- (void)showPayVC{
    //如果没有登录
    if ([self isFailForCheckLogInStatus]) {
        return;
    }
    
    //如果正在执行登陆
    if (self.isPerformLogIn) {
        return;
    }
    //改变状态，再次点击不执行登陆
    self.isPerformLogIn  = YES;
    DaShangViewController *dashang = [[DaShangViewController alloc] initWithNibName:@"DaShangViewController" bundle:[NSBundle mainBundle]];
    
    //支付类型：通用
    dashang.isCustomPay = YES;
    dashang.photoId = self.webPayTargetID;
    //当前用户，本人的uid
    dashang.uid = getCurrentUid();
    //需要支付的总金额
    dashang.money = self.webPayAmount;
    //支付标题和描述
    dashang.customTitle = self.webPayTitle;
    dashang.customDesc = self.webPayDesc;
    //打赏对方类型:6/12/11/17/16
    dashang.customPayTargetType = self.webPayTargetType;
    
    //测试
    [self.navigationController pushViewController:dashang animated:YES];
}


//接收到微信支付成功的消息之后，是否要调起当前h5界面的回调
- (BOOL)isFailForCallBack{
    //回调函数名参数不存在时，返回NO,不继续执行支付成功或者失败的回调
    if((self.webPayCallBackFunc == nil)||(self.webPayCallBackFunc.length == 0)){
        //支付信息不完整不会调起支付
        return YES;
    }else{
        return NO;
    }
}
//通知：微信支付成功
- (void)weiXinPaySuccess{
    if ([self isFailForCallBack]) {
        return;
    }
    [self performWeiXinpay:@"1"];
}
//通知：微信支付失败
- (void)weiXinPayFail{
    if ([self isFailForCallBack]) {
    }
    [self performWeiXinpay:@"0"];
}


//支付回调方法
- (void)performWeiXinpay:(NSString *)status{
    //调起h5的方法
    JSContext *context_=[self.webView valueForKeyPath:@"documentView.webView.mainFrame.javaScriptContext"];
    NSString *funcStr = [NSString stringWithFormat:@"%@(%@,\"%@\")",self.webPayCallBackFunc,status,self.webPaycallBackData];
    [context_ evaluateScript:funcStr];
}



#pragma mark - 其他方法
//清除上次从h5获取的支付信息
- (void)clearPayParameters{
    _webPayCallBackFunc = nil;
}



#pragma mark - NJKWebViewProgressDelegate
-(void)webViewProgress:(NJKWebViewProgress *)webViewProgress updateProgress:(float)progress
{
    [_progressView setProgress:progress animated:NO];
}


#pragma mark - set/get方法
- (UIWebView *)webView{
    if (_webView == nil) {
        _webView = [[UIWebView alloc] initWithFrame:CGRectMake(0, 0, kScreenWidth, kScreenHeight-64)];
        //webView代理
        _webView.delegate = self;
        //Scrollview代理
        _webView.scrollView.delegate = self;
        _webView.scalesPageToFit = YES;
        _webView.scrollView.showsHorizontalScrollIndicator = NO;
        _webView.scrollView.zoomScale = 1.0;
        _webView.scrollView.showsVerticalScrollIndicator = YES;
    }
    return _webView;
}



@end
